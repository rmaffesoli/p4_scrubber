# P4 Scrubber [![Coverage Status](https://coveralls.io/repos/github/rmaffesoli/p4_scrubber/badge.svg?branch=main)](https://coveralls.io/github/rmaffesoli/p4_scrubber?branch=main)

## Overview

This P4 Scrubber Tool can be used to quickly remove depots, streams, users, groups, clients, shelfed files, and permissions from your P4 server. 

* Who Is the P4 Scrubber Tool for? 

  * Admins of enviroments that need to quickly and easily remove large quanities of content and setup from their P4 Environment. This tool was built with Educational institutions in mind first and foremost. At the end of a semester there is often a need to regain storage space assigned to users for a limited ammount if time. 



* What Does the P4 Scrubber Tool Do? 

  * Allows admin users to define.

    * Users can create and define the following types of objects: depots, streams, user groups permission table entries, typemap table entries, and branches that can be used to prepopulate a new depot from an existing depot in your Helix Core server. 

 

* How to Use P4 Scrubber Tool

  * Once defined, users can easily reuse individual project style templates with variable definitions when creating and deploying similar future projects.  

  * At any point a project template may be redefined and saved in place or as a new file if your project needs change. 


## Installation

Currently, the running the main kernel via source doesn't require any additional libraries beyond Python3
The UI currently requires PyQt6.

## Requirements
##### CLI:
p4python                  2023.2.2581979\

##### EXE BUILD Requirements:
altgraph                  0.17.4\
packaging                 24.0\
pefile                    2023.2.7\
pyinstaller               6.5.0\
pyinstaller-hooks-contrib 2024.3\
pywin32-ctypes            0.2.2\
setuptools                69.2.0

##### Testing requirements:
colorama                  0.4.6\
coverage                  7.4.4\
iniconfig                 2.0.0\
pluggy                    1.4.0\
pytest                    8.1.1\
pytest-cov                5.0.0\
pytest-mock               3.14.0


## Server Configuration File

* Server configuration is taken from the `config.json` that can either be positioned next to the exe file or passed in as a command line argument when calling the tool.
```bash
{
    "server":{
        "port": "ssl:helix_core_server:1666",
        "user": "username",
        "password": null,
        "charset": "none"
    }
}

```

## Manifest.json
* This tool operates by using a 

```bash
{
    "depots": [
        "delete_me_stream"
    ],
    "users": [
        "delete_me_user"
    ],
    "streams": [
        "//delete_me_stream/main",
        "//delete_me_stream/dev"
    ],
    "clients": [
        "delete_me_client"
    ],
    "groups": [
        "delete_me_group"
    ],
    "shelves": [
        "111"
    ],
    "permissions": [
        {
            "access": "write",
            "type": "user",
            "name": "*",
            "host": "*",
            "path": "//delete_me_stream/...",
            "comment": ""
        }
    ]
}

```

## CLI Usage

* To process a manifest.json file pass in the file path with the -m flag. If you leave this argument the tool will try to find a manifest.json file that is next to the tool in the folder structure.
* To pass in your server configurations pass in the file path with the -c flag. If you leave this argument the tool will try to find a config.json file that is next to the tool in the folder structure.
* The tool will run in a dryrun mode initially and report back what it will do without making any changes. If you would like to run the tool in full you need to include the -y flag to actually proceed with the deletion process


```bash
python ./p4_scrubber_tool -c config.json -m manifest.json -y 
```

## Automatic prequisite tracing. 
* Certain deletion events require that all of the assets children have been removed prior allowing for a delete/obliterate command being run. So if you provide a depot to be obliterated, be aware that all streams in that depot will be obliterated prior.

* Clients : Shelved files
* Streams : all clients, shelved files, and child streams
* Depots : all streams, clients, and shelved files
* Users  : all clients, ,shelved files, and groups where this user is the last user

## EXE Build
* If you have the pyinstaller requirements installed. `build_windows.bat` will create a self contained executable in the bin directory.

## Testing

* run_tests.bat should take care of things so long as you have the testing requirements installed. Currently basic unit tests are in place. If you update the code at all be sure to update the tests accordingly. Test results will be available via command line and coverage reports can be viewed via the `html-cov/index.html` file that will be generated by coverage.
* This script will attempt to upload test results to coveralls, however don't be concerned if this portion fails as it does require a private repo_token that will not be included in this github repository.

## TODO Wishlist
- [ ] Documentation
  - More than a readme is likely needed.
- [ ] Better Reporting
  - I would like a full report generated whenever this tool is run. 
